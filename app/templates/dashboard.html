<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      display: flex;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    .sidebar {
      width: 250px;
      background-color: #212529;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .sidebar .nav-link {
      color: white;
      padding: 0.5rem 1rem;
      display: block;
      text-decoration: none;
    }
    .sidebar .nav-link.active {
      background-color: #0d6efd;
    }
    .sidebar .logout {
      margin: 1rem;
    }
    .content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    .chart-container {
      display: flex;
      gap: 1rem;
      width: 100%;
    }
    .chart {
      flex: 1;
      height: 400px;
      border: 1px solid #000;
      position: relative;
    }
    .chart div.plotly-graph-div {
      width: 100% !important;
      height: 100% !important;
    }
    .table-section {
      margin-top: 2rem;
    }
    .table-header-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div>
      <h3 class="text-center mt-3">Dashboard</h3>
      <ul class="nav flex-column mt-4">
        <li class="nav-item">
          <a href="/" class="nav-link active">Home</a>
        </li>
        <li class="nav-item">
          <a href="/budgets" class="nav-link">Budgets</a>
        </li>
      </ul>
    </div>
    <div class="logout">
      <button id="logoutBtn" class="btn btn-outline-light w-100">Logout</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <h2 class="mb-4">Dashboard Overview</h2>

    <div class="chart-container">
      <div class="chart" id="expenses_chart">Loading expenses...</div>
      <div class="chart" id="incomes_chart">Loading incomes...</div>
    </div>

    <div class="table-section">
      <div class="table-header-buttons">
        <div>
          <button class="btn btn-outline-primary" id="detailsBtn">Detailed view</button>
          <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#addBudgetModal">Add Budget</button>
        </div>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Category</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody id="recentTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Add Budget Modal -->
  <div class="modal fade" id="addBudgetModal" tabindex="-1" aria-labelledby="addBudgetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addBudgetModalLabel">Add New Budget</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addBudgetForm">
            <div class="mb-3">
              <label for="budgetMonth" class="form-label">Month</label>
              <input type="number" class="form-control" id="budgetMonth" min="1" max="12" required>
            </div>
            <div class="mb-3">
              <label for="budgetYear" class="form-label">Year</label>
              <input type="number" class="form-control" id="budgetYear" min="2000" max="2100" required>
            </div>
            <div class="mb-3">
              <label for="amount" class="form-label">Amount</label>
              <input type="number" class="form-control" id="amount" step="0.01" required>
            </div>
            <div class="mb-3">
              <label for="budgetStatus" class="form-label">Status</label>
              <select id="budgetStatus" class="form-select" required></select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveBudgetBtn">Save Budget</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <script>
    async function drawExpensesChart() {
      const container = document.getElementById("expenses_chart");
      try {
        const response = await fetch("/api/dashboard/get_curr_expenses");
        const categories = data.map(item => item.Category);
        const amounts = data.map(item => parseFloat(item.Amount));
        const trace = { x: categories || [], y: amounts || [], type: 'bar', marker: { color: 'tomato' } };
        Plotly.newPlot(container, [trace], { title: 'Expenses', margin: { t: 40, b: 40 } });
      } catch (err) {
        console.error("Expenses chart error:", err);
      }
    }

    async function drawIncomesChart() {
      const container = document.getElementById("incomes_chart");
      try {
        const response = await fetch("/api/dashboard/get_curr_incomes");
        const data = await response.json();
        const categories = data.map(item => item.Category);
        const amounts = data.map(item => parseFloat(item.Amount));
        const trace = { x: categories || [], y: amounts || [], type: 'bar', marker: { color: 'mediumseagreen' } };
        Plotly.newPlot(container, [trace], { title: 'Incomes', margin: { t: 40, b: 40 } });
      } catch (err) {
        console.error("Incomes chart error:", err);
      }
    }

    function loadRecent() {
      const table = document.getElementById("recentTable");
      fetch("/api/dashboard/get_last_transactions")
        .then(res => res.json())
        .then(data => {
          table.innerHTML = "";
          if (!data || data.length === 0) {
            table.innerHTML = `<tr><td colspan="4" class="text-center">Nothing there yet</td></tr>`;
          } else {
            data.slice(0, 5).forEach(item => {
              table.innerHTML += `
                <tr>
                  <td>${item.date || "-"}</td>
                  <td>${item.type || "-"}</td>
                  <td>${item.name || "-"}</td>
                  <td>${item.amount || "-"}</td>
                </tr>`;
            });
          }
        });
    }

    async function populateStatusSelect() {
      const statusSelect = document.getElementById("budgetStatus");
      statusSelect.innerHTML = "";
      try {
        const res = await fetch("/api/budgets/get_statuses", {
          headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
        });
        const data = await res.json();
        const statuses = Array.isArray(data) ? data : data.budgets || [];

        if (!statuses.length) {
          const opt = document.createElement("option");
          opt.textContent = "No statuses found";
          statusSelect.appendChild(opt);
          return;
        }

        statuses.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.name;
          statusSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("Failed to load statuses:", err);
        const opt = document.createElement("option");
        opt.textContent = "Error loading statuses";
        statusSelect.appendChild(opt);
      }
    }

    const addBudgetModal = document.getElementById("addBudgetModal");
    addBudgetModal.addEventListener("show.bs.modal", () => {
      const now = new Date();
      document.getElementById("budgetMonth").value = now.getMonth() + 1;
      document.getElementById("budgetYear").value = now.getFullYear();
      populateStatusSelect(); // fetch fresh statuses every time modal opens
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "/login";
    });

    document.getElementById("saveBudgetBtn").addEventListener("click", async () => {
      const payload = {
        budget_month: document.getElementById("budgetMonth").value,
        budget_year: document.getElementById("budgetYear").value,
        amount: document.getElementById("amount").value,
        status_id: document.getElementById("budgetStatus").value
      };

      try {
        const res = await fetch("/api/budgets/create_budget", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("token")
          },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          alert("Budget added successfully!");
          location.reload();
        } else {
          const errData = await res.json();
          alert("Failed: " + (errData.message || "Error adding budget"));
        }
      } catch (err) {
        console.error(err);
        alert("Error adding budget.");
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      drawExpensesChart();
      drawIncomesChart();
      loadRecent();
    });
  </script>
</body>
</html>
