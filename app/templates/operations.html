<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Budget Operations</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { padding: 1rem; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .table-container { max-height: 60vh; overflow-y: auto; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .switch-add { display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem; gap:1rem; }
  </style>
</head>
<body>
  <div class="top-bar">
    <h4 id="budgetTitle">Budget Details</h4>
    <a href="/budgets" class="btn btn-outline-secondary">← Back to Budgets</a>
  </div>

  <div class="switch-add">
    <div>
      <button id="addBtn" class="btn btn-primary">Add</button>
    </div>
    <div>
      <div class="form-check form-switch">
        <input class="form-check-input" id="opsToggle" type="checkbox" />
        <label class="form-check-label" for="opsToggle" id="opsLabel">Incomes</label>
      </div>
    </div>
  </div>

  <div class="table-container">
    <table class="table table-striped align-middle" id="opsTable">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Date</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Cyclical</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="opsTBody"></tbody>
    </table>
  </div>

  <!-- Add Modal -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="addForm">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">Add Operation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Amount</label>
            <input id="addAmount" type="number" step="0.01" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select id="addCategory" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Date</label>
            <input id="addDate" type="date" class="form-control" required />
          </div>
          <div class="form-check mb-0">
            <input id="addCyclical" class="form-check-input" type="checkbox" />
            <label class="form-check-label" for="addCyclical">Cyclical</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="addSubmit" type="submit" class="btn btn-primary">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="editForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Operation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editId" />
          <div class="mb-3">
            <label class="form-label">Amount</label>
            <input id="editAmount" type="number" step="0.01" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select id="editCategory" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Date</label>
            <input id="editDate" type="date" class="form-control" required />
          </div>
          <div class="form-check mb-0">
            <input id="editCyclical" class="form-check-input" type="checkbox" />
            <label class="form-check-label" for="editCyclical">Cyclical</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="editSubmit" type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

<script>
const opsTBody   = document.getElementById('opsTBody');
const opsToggle  = document.getElementById('opsToggle');
const opsLabel   = document.getElementById('opsLabel');
const addBtn     = document.getElementById('addBtn');

const addModal    = new bootstrap.Modal(document.getElementById('addModal'));
const editModal   = new bootstrap.Modal(document.getElementById('editModal'));

const addForm     = document.getElementById('addForm');
const addAmount   = document.getElementById('addAmount');
const addCategory = document.getElementById('addCategory');
const addDate     = document.getElementById('addDate');
const addCyclical = document.getElementById('addCyclical');

const editForm     = document.getElementById('editForm');
const editId       = document.getElementById('editId');
const editAmount   = document.getElementById('editAmount');
const editCategory = document.getElementById('editCategory');
const editDate     = document.getElementById('editDate');
const editCyclical = document.getElementById('editCyclical');

const budgetTitle  = document.getElementById('budgetTitle');

let budgetId = null;
let budgetMonth = null;
let budgetYear = null;
let dateMin = null;
let dateMax = null;

let dataCache = { incomes: [], expenses: [] };

function getBudgetIdFromURL() {
  return new URLSearchParams(window.location.search).get('budget_id');
}

function pad(n){ return n<10 ? '0'+n : ''+n; }

function setDateBoundsFromMonthYear(year, month) {
  const first = new Date(year, month -1, 1);
  const last  = new Date(year, month, 0);
  dateMin = `${first.getFullYear()}-${pad(first.getMonth()+1)}-${pad(first.getDate())}`;
  dateMax = `${last.getFullYear()}-${pad(last.getMonth()+1)}-${pad(last.getDate())}`;
  addDate.min = dateMin; addDate.max = dateMax;
  editDate.min = dateMin; editDate.max = dateMax;
}

async function fetchCategories(type) {
  const endpoint = type === 'incomes' ? '/api/incomes/get_categories' : '/api/expenses/get_categories';
  const res = await fetch(endpoint, { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }});
  if (!res.ok) { alert('Failed load categories'); return []; }
  return res.json();
}

function fillSelectWithCategories(selectEl, categories, selectedId=null) {
  selectEl.innerHTML = '';
  categories.forEach(c => {
    const id = c.id ?? c.category_id;
    const name = c.name ?? c.category_name;
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = name;
    if (String(selectedId) === String(id)) opt.selected = true;
    selectEl.appendChild(opt);
  });
}

function renderTable() {
  const type = opsToggle.checked ? 'expenses' : 'incomes';
  opsLabel.textContent = opsToggle.checked ? 'Expenses' : 'Incomes';
  const list = dataCache[type] || [];
  opsTBody.innerHTML = '';
  if (!list.length) {
    opsTBody.innerHTML = `<tr><td colspan="6" class="text-center">No ${type} yet</td></tr>`;
    return;
  }
  list.forEach(item => {
    const id = item.income_id ?? item.expense_id ?? item.id;
    const rawDate = item.income_date ?? item.expense_date ?? item.date ?? item.created_at;
    const date = rawDate ? (rawDate.split ? rawDate.split('T')[0] : rawDate) : '-';
    const catName = item.category_name ?? item.category ?? '-';
    const amount = item.amount ?? '-';
    const cyc = (item.is_cyclical === true || item.is_cyclical === 'true') ? '✅' : '❌';
    opsTBody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${id}</td>
        <td>${date}</td>
        <td>${catName}</td>
        <td>${amount}</td>
        <td>${cyc}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" onclick="onEdit(${id}, '${type}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="onDelete(${id}, '${type}')">Delete</button>
        </td>
      </tr>
    `);
  });
}

async function loadBudgetDetails(bId) {
  budgetId = bId;
  const res = await fetch(`/api/budgets/${bId}/get_budget_details`, {
    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
  });
  if (!res.ok) {
    opsTBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load budget details</td></tr>`;
    return;
  }
  const payload = await res.json();
  dataCache.expenses = payload.expenses ?? payload[0] ?? [];
  dataCache.incomes  = payload.incomes  ?? payload[1] ?? [];
  const d = payload.date ? new Date(payload.date) : new Date();
  budgetMonth = d.getMonth()+1; budgetYear = d.getFullYear();
  setDateBoundsFromMonthYear(budgetYear, budgetMonth);
  budgetTitle.textContent = `Budget #${budgetId} — ${pad(budgetMonth)}/${budgetYear}`;
  renderTable();
}

addBtn.addEventListener('click', async () => {
  const type = opsToggle.checked ? 'expenses' : 'incomes';
  const cats = await fetchCategories(type);
  fillSelectWithCategories(addCategory, cats);
  addForm.reset();
  addDate.value = dateMin ?? new Date().toISOString().split('T')[0];
  addCyclical.checked = false;
  document.getElementById('addModalLabel').textContent = `Add ${type.slice(0, -1).charAt(0).toUpperCase() + type.slice(1, -1)}`;
  addModal.show();
});

addForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const type = opsToggle.checked ? 'expenses' : 'incomes';
  const endpoint = type === 'expenses' ? '/api/expenses/add_expense' : '/api/incomes/add_income';
  const payload = {
    amount: parseFloat(addAmount.value),
    category_id: parseInt(addCategory.value),
    date: addDate.value,
    is_cyclical: Boolean(addCyclical.checked),
    budget_id: Number(budgetId)
  };
  const res = await fetch(endpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + localStorage.getItem('token')
    },
    body: JSON.stringify(payload)
  });
  if (res.ok) {
    addModal.hide();
    await loadBudgetDetails(budgetId);
  } else {
    const err = await res.json().catch(()=>({message:'Error'}));
    alert('Failed to add: ' + (err.message || res.status));
  }
});

window.onEdit = async function(id, type) {
  opsToggle.checked = (type === 'expenses');
  opsLabel.textContent = opsToggle.checked ? 'Expenses' : 'Incomes';
  const list = dataCache[type] || [];
  const item = list.find(x => String(x.income_id ?? x.expense_id ?? x.id) === String(id));
  if (!item) { alert('Item not found'); return; }
  const cats = await fetchCategories(type);
  fillSelectWithCategories(editCategory, cats, item.category_id);
  editId.value = id;
  editAmount.value = item.amount ?? '';
  const rawDate = item.income_date ?? item.expense_date ?? item.date ?? '';
  editDate.value = rawDate ? (rawDate.split ? rawDate.split('T')[0] : rawDate) : (dateMin ?? '');
  editCyclical.checked = (item.is_cyclical === true || item.is_cyclical === 'true');
  document.getElementById('editModalLabel').textContent = `Edit ${type.slice(0, -1).charAt(0).toUpperCase() + type.slice(1, -1)}`;
  editModal.show();
};

editForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const type = opsToggle.checked ? 'expenses' : 'incomes';
  const id = parseInt(editId.value);
  const endpoint = type === 'expenses'
    ? '/api/expenses/edit_expense'
    : '/api/incomes/edit_income';
  const payload = {
    amount: parseFloat(editAmount.value),
    category_id: parseInt(editCategory.value),
    date: editDate.value,
    is_cyclical: Boolean(editCyclical.checked)
  };
  // ✅ Add ID to body
  if (type === 'expenses') payload.expense_id = id;
  else payload.income_id = id;

  const res = await fetch(endpoint, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + localStorage.getItem('token')
    },
    body: JSON.stringify(payload)
  });
  if (res.ok) {
    editModal.hide();
    await loadBudgetDetails(budgetId);
  } else {
    const err = await res.json().catch(()=>({message:'Error'}));
    alert('Failed to edit: ' + (err.message || res.status));
  }
});

/* --------- Delete --------- */
window.onDelete = async function(id, type) {
  if (!confirm('Are you sure?')) return;

  const endpoint = type === 'expenses'
    ? '/api/expenses/delete_expense'
    : '/api/incomes/delete_income';

  const key = type === 'expenses' ? 'expense_id' : 'income_id';
  const payload = {};
  payload[key] = Number(id);

  const res = await fetch(endpoint, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + localStorage.getItem('token')
    },
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    dataCache[type] = (dataCache[type] || []).filter(x =>
      String(x.income_id ?? x.expense_id ?? x.id) !== String(id)
    );
    renderTable();
  } else {
    const err = await res.json().catch(()=>({message:'Error'}));
    alert('Delete failed: ' + (err.message || res.status));
  }
};


document.addEventListener('DOMContentLoaded', async () => {
  const id = getBudgetIdFromURL();
  if (!id) {
    opsTBody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">Missing budget_id query param</td></tr>`;
    return;
  }
  await loadBudgetDetails(id);
  opsToggle.addEventListener('change', () => renderTable());
});
</script>
</body>
</html>
