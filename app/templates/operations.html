<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Budget Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { padding: 1rem; }
    .table-container { max-height: 500px; overflow-y: auto; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .switch-add-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <div class="top-bar">
    <h4 id="budgetTitle">Budget Details</h4>
    <a href="/budgets" class="btn btn-outline-secondary">‚Üê Back to Budgets</a>
  </div>

  <div class="switch-add-container">
    <button class="btn btn-primary" id="addOpsBtn">Add</button>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="opsToggleSwitch">
      <label class="form-check-label" for="opsToggleSwitch" id="opsToggleLabel">Incomes</label>
    </div>
  </div>

  <div class="table-container">
    <table class="table table-striped align-middle" id="budgetOpsTable">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Date</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filled dynamically -->
      </tbody>
    </table>
  </div>

  <!-- Add Income/Expense Modal -->
  <div class="modal fade" id="addOpsModal" tabindex="-1" aria-labelledby="addOpsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addOpsForm">
          <div class="modal-header">
            <h5 class="modal-title" id="addOpsModalLabel">Add Operation</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="opsAmount" class="form-label">Amount</label>
              <input type="number" step="0.01" class="form-control" id="opsAmount" required>
            </div>
            <div class="mb-3">
              <label for="opsCategory" class="form-label">Category</label>
              <select class="form-select" id="opsCategory" required>
                <!-- Populated dynamically -->
              </select>
            </div>
            <div class="mb-3">
              <label for="opsDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="opsDate" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const tableBody = document.querySelector("#budgetOpsTable tbody");
    const toggleSwitch = document.getElementById("opsToggleSwitch");
    const toggleLabel = document.getElementById("opsToggleLabel");
    const addOpsBtn = document.getElementById("addOpsBtn");
    const addOpsModal = new bootstrap.Modal(document.getElementById("addOpsModal"));
    const addOpsForm = document.getElementById("addOpsForm");
    const opsCategory = document.getElementById("opsCategory");
    const opsAmount = document.getElementById("opsAmount");
    const opsDate = document.getElementById("opsDate");
    const title = document.getElementById("budgetTitle");

    let currentBudgetId = null;
    let budgetData = { incomes: [], expenses: [] };
    let categoriesCache = { incomes: [], expenses: [] };

    function getBudgetIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("budget_id");
    }

    async function fetchCategories(type) {
      if (categoriesCache[type].length > 0) return categoriesCache[type];
      const endpoint = type === "incomes" ? "/api/incomes/get_categories" : "/api/expenses/get_categories";
      const res = await fetch(endpoint, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } });
      if (!res.ok) return alert(`Failed to load ${type} categories`);
      const data = await res.json();
      categoriesCache[type] = data;
      return data;
    }

    function populateCategoryDropdown(type) {
      opsCategory.innerHTML = "";
      fetchCategories(type).then(data => {
        data.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.name;
          opsCategory.appendChild(opt);
        });
      });
    }

    async function loadBudgetDetails(budgetId) {
      currentBudgetId = budgetId;
      const res = await fetch(`/api/budgets/${budgetId}/get_budget_details`, {
        headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
      });

      if (!res.ok) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load budget details</td></tr>`;
        return;
      }

      const { expenses, incomes } = await res.json(); // backend must return { expenses: [...], incomes: [...] }
      budgetData = { expenses, incomes };
      title.textContent = `Budget #${budgetId} Details`;
      renderTable();
    }

    function renderTable() {
      const type = toggleSwitch.checked ? "expenses" : "incomes";
      toggleLabel.textContent = type.charAt(0).toUpperCase() + type.slice(1);
      const data = budgetData[type];
      tableBody.innerHTML = "";

      if (!data || data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No ${type} yet</td></tr>`;
        return;
      }

      data.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.id}</td>
          <td>${item.date || "-"}</td>
          <td>${item.category_name || "-"}</td>
          <td>${item.amount || "-"}</td>
          <td>${item.description || "-"}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editOperation(${item.id}, '${type}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteOperation(${item.id}, '${type}')">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    toggleSwitch.addEventListener("change", () => {
      renderTable();
      populateCategoryDropdown(toggleSwitch.checked ? "expenses" : "incomes");
    });

    addOpsBtn.addEventListener("click", () => {
      const type = toggleSwitch.checked ? "expenses" : "incomes";
      populateCategoryDropdown(type);
      opsAmount.value = "";
      opsDate.value = new Date().toISOString().split("T")[0];
      addOpsModal.show();
    });

    addOpsForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const type = toggleSwitch.checked ? "expenses" : "incomes";
      const endpoint = type === "expenses" ? "/api/expenses/add_expense" : "/api/incomes/add_income";

      const payload = {
        amount: parseFloat(opsAmount.value),
        category_id: parseInt(opsCategory.value),
        date: opsDate.value,
        budget_id: currentBudgetId
      };

      const res = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        alert(`${type.charAt(0).toUpperCase() + type.slice(1)} added!`);
        addOpsModal.hide();
        loadBudgetDetails(currentBudgetId);
      } else {
        alert(`Failed to add ${type}`);
      }
    });

    function editOperation(id, type) {
      alert(`Edit ${type} ID ${id} (implement modal here)`);
    }

    function deleteOperation(id, type) {
      if (!confirm(`Are you sure you want to delete this ${type}?`)) return;
      fetch(`/api/budgets/${currentBudgetId}/${type}/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
      })
      .then(res => {
        if (res.ok) {
          budgetData[type] = budgetData[type].filter(x => x.id !== id);
          renderTable();
        } else {
          alert(`Failed to delete ${type}`);
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const id = getBudgetIdFromURL();
      if (!id) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Missing budget ID</td></tr>`;
        return;
      }
      loadBudgetDetails(id);
    });
  </script>
</body>
</html>
